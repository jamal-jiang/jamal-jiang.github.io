<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






  <meta name="baidu-site-verification" content="EQ8iDaZYMG" />







  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Linux,Jstorm,分布式" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="gethostbyname与DNS
title: gethostbyname与DNSdate: 2017-12-14 02:50:54tags:

Linuxcategories: Linux


下午验证商户的时候发现一个奇怪的问题，商户本地没绑host，但是仍然只能访问到一个ip，后来排查是因为对方机器本地有nscd进程在跑（这里不得不吐槽，不是自己的机器找人执行命令真是难），中间有一个比较有">
<meta property="og:type" content="article">
<meta property="og:title" content="落玄的博客">
<meta property="og:url" content="https://jamal-jiang.github.io/2017/12/13/gethostbyname与DNS/index.html">
<meta property="og:site_name" content="落玄的博客">
<meta property="og:description" content="gethostbyname与DNS
title: gethostbyname与DNSdate: 2017-12-14 02:50:54tags:

Linuxcategories: Linux


下午验证商户的时候发现一个奇怪的问题，商户本地没绑host，但是仍然只能访问到一个ip，后来排查是因为对方机器本地有nscd进程在跑（这里不得不吐槽，不是自己的机器找人执行命令真是难），中间有一个比较有">
<meta property="og:updated_time" content="2017-12-13T18:51:18.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="落玄的博客">
<meta name="twitter:description" content="gethostbyname与DNS
title: gethostbyname与DNSdate: 2017-12-14 02:50:54tags:

Linuxcategories: Linux


下午验证商户的时候发现一个奇怪的问题，商户本地没绑host，但是仍然只能访问到一个ip，后来排查是因为对方机器本地有nscd进程在跑（这里不得不吐槽，不是自己的机器找人执行命令真是难），中间有一个比较有">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://jamal-jiang.github.io/2017/12/13/gethostbyname与DNS/"/>





  <title>  | 落玄的博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">落玄的博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <h1 class="site-subtitle" itemprop="description">落玄的博客</h1>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://jamal-jiang.github.io/2017/12/13/gethostbyname与DNS/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="jamal-jiang">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="落玄的博客">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="落玄的博客" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-13T19:49:27+08:00">
                2017-12-13
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="gethostbyname与DNS"><a href="#gethostbyname与DNS" class="headerlink" title="gethostbyname与DNS"></a>gethostbyname与DNS</h1><hr>
<p>title: gethostbyname与DNS<br>date: 2017-12-14 02:50:54<br>tags:</p>
<ul>
<li>Linux<br>categories: Linux</li>
</ul>
<hr>
<p>下午验证商户的时候发现一个奇怪的问题，商户本地没绑host，但是仍然只能访问到一个ip，后来排查是因为对方机器本地有nscd进程在跑（这里不得不吐槽，不是自己的机器找人执行命令真是难），中间有一个比较有意思的事情，ping的时候只能ping到一个ip，但是dig能跑出两个，这个其实比较容易知道是什么原因导致的，但是这里就有一个比较有意思的点可以去探究的：<br>我们都清楚或者说知道DNS解析的大概流程，也大概知道可能会有host绑定、缓存等等的情况出现，但是细想一下好像都说不清具体在代码层面Linux系统是怎么去做这件事情的，所以不妨手动做一下测试，看看究竟是怎么做的。<br>我们从ping开始，首先ltrace跟踪一下ping的代码执行过程：ltrace ping -c 1 baidu.com 2&gt;&amp;1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@izj6c3cqwumhn7qc8it7wiz log]# ltrace ping -c 1 baidu.com 2&gt;&amp;1 | grep get</div><div class="line">cap_get_proc(0x7ffcb9159230, 0x7ffcb9159348, 0x7ffcb9159370, 0) = 0x55dc4ce20014</div><div class="line">cap_get_flag(0x55dc4ce20014, 12, 1, 0x7ffcb9159194) = 0</div><div class="line">cap_get_flag(0x55dc4ce20014, 13, 1, 0x7ffcb9159194) = 0</div><div class="line">getuid()                                         = 0</div><div class="line">getuid()                                         = 0</div><div class="line">geteuid()                                        = 0</div><div class="line">getopt(4, 0x7ffcb9159348, &quot;h?4bRT:6F:N:aABc:dDfi:I:l:Lm:M:n&quot;...) = 99</div><div class="line">getopt(4, 0x7ffcb9159348, &quot;h?4bRT:6F:N:aABc:dDfi:I:l:Lm:M:n&quot;...) = -1</div><div class="line">cap_get_proc(13, 1, 3, 0)                        = 0x55dc4ce20014</div><div class="line">cap_get_flag(0x55dc4ce20014, 13, 1, 0x7ffcb9159194) = 0</div><div class="line">cap_get_proc(13, 0, 1, -1)                       = 0x55dc4ce20014</div><div class="line">cap_get_flag(0x55dc4ce20014, 13, 1, 0x7ffcb9159194) = 0</div><div class="line">getaddrinfo(&quot;baidu.com&quot;, nil, 0x7ffcb9159200, 0x7ffcb91591d8) = 0</div><div class="line">getsockname(4, 0x55dc4c3fa070, 0x7ffcb9158cec, -1) = 0</div><div class="line">getsockopt(3, 1, 8, 0x7ffcb9158ca0)              = 0</div><div class="line">getpid()                                         = 16594</div><div class="line">gettimeofday(0x55dc4c3fc6c0, nil)                = 0</div><div class="line">gettimeofday(0x55dc4c3fe6f0, nil)                = 0</div><div class="line">gettimeofday(0x7ffcb9157ad0, nil)                = 0</div><div class="line">getnameinfo(0x7ffcb9157c00, 16, &quot;&quot;, 1025, nil, 0, 33) = 0</div><div class="line">getnameinfo(0x7ffcb9157c00, 16, &quot;&quot;, 1025, nil, 0, 32) = 0</div></pre></td></tr></table></figure>
<p>至于为啥我要执行grep get，只是知道以前写echoserver这种tcp应用的时候会用到gethostbyname而已，哈哈。<br>不过这里是没有这个函数的，但是我注意到了有这么一个函数：getaddrinfo，man一下看到了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Given  node  and service, which identify an Internet host and a service, getaddrinfo() returns one or more addrinfo structures, each</div><div class="line">       of which contains an Internet address that can be specified in a call to bind(2) or connect(2).  The getaddrinfo() function combines</div><div class="line">       the  functionality  provided  by  the gethostbyname(3) and getservbyname(3) functions into a single interface, but unlike the latter</div><div class="line">       functions, getaddrinfo() is reentrant and allows programs to eliminate IPv4-versus-IPv6 dependencies.</div></pre></td></tr></table></figure>
<p>其实就是gethostbyname和getservbyname的结果封装了一下，只是gethostbyname被认为是一个已经过期的函数，正好我这个系统是centos7的，ping的版本也比较高，默认用了getaddrinfo，这里我们忽略其中的差异，直接用gethostbyname来做实验，先写一串代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">[root@izj6c3cqwumhn7qc8it7wiz c]<span class="meta"># cat gethostbyname.c </span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line">main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</div><div class="line">&#123;</div><div class="line">   <span class="keyword">struct</span> hostent *hp;</div><div class="line">   <span class="keyword">struct</span> in_addr ip_addr;</div><div class="line"></div><div class="line">   <span class="comment">/* Verify a "hostname" parameter was supplied */</span></div><div class="line">   <span class="keyword">if</span> (argc &lt;<span class="number">1</span> || *argv[<span class="number">1</span>] == <span class="string">'\0'</span>)</div><div class="line">      <span class="built_in">exit</span>(EXIT_FAILURE);</div><div class="line"></div><div class="line"><span class="comment">/* call gethostbyname() with a host name. gethostbyname() returns a */</span></div><div class="line"><span class="comment">/* pointer to a hostent struct or NULL.                             */</span></div><div class="line">   hp = gethostbyname(argv[<span class="number">1</span>]);</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (!hp) &#123;</div><div class="line">      <span class="built_in">printf</span>(<span class="string">"%s was not resolved\n"</span>,argv[<span class="number">1</span>]);</div><div class="line">      <span class="built_in">exit</span>(EXIT_FAILURE);</div><div class="line">   &#125;</div><div class="line"></div><div class="line"><span class="comment">/* move h_addr to ip_addr. This enables conversion to a form        */</span></div><div class="line"><span class="comment">/* suitable for printing with the inet_ntoa() function.             */</span></div><div class="line"></div><div class="line">   ip_addr = *(<span class="keyword">struct</span> in_addr *)(hp-&gt;h_addr);</div><div class="line">   <span class="built_in">printf</span>(<span class="string">"Hostname: %s, was resolved to: %s\n"</span>,</div><div class="line">           argv[<span class="number">1</span>],inet_ntoa(ip_addr));</div><div class="line"></div><div class="line">   <span class="built_in">exit</span>(EXIT_SUCCESS);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编译一下，用./gethostbyname “intl.alipay.com” 就能直接运行，于是下面开始做实验。</p>
<h4 id="实验过程"><a href="#实验过程" class="headerlink" title="实验过程"></a>实验过程</h4><ul>
<li>常规使用</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">[root@izj6c3cqwumhn7qc8it7wiz c]# strace ./gethostbyname &quot;intl.alipay.com&quot; 2&gt;&amp;1 | grep -vE &quot;mmap|munmap|mprotect&quot;</div><div class="line">execve(&quot;./gethostbyname&quot;, [&quot;./gethostbyname&quot;, &quot;intl.alipay.com&quot;], [/* 26 vars */]) = 0</div><div class="line">brk(NULL)                               = 0x2522000</div><div class="line">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</div><div class="line">open(&quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=50151, ...&#125;) = 0</div><div class="line">close(3)                                = 0</div><div class="line">open(&quot;/lib64/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">read(3, &quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\20\35\2\0\0\0\0\0&quot;..., 832) = 832</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=2127336, ...&#125;) = 0</div><div class="line">close(3)                                = 0</div><div class="line">arch_prctl(ARCH_SET_FS, 0x7fe0a622f740) = 0</div><div class="line">brk(NULL)                               = 0x2522000</div><div class="line">brk(0x2543000)                          = 0x2543000</div><div class="line">brk(NULL)                               = 0x2543000</div><div class="line">getpid()                                = 15961</div><div class="line">open(&quot;/etc/resolv.conf&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=108, ...&#125;) = 0</div><div class="line">read(3, &quot;nameserver 100.100.2.138\nnameser&quot;..., 4096) = 108</div><div class="line">read(3, &quot;&quot;, 4096)                       = 0</div><div class="line">close(3)                                = 0</div><div class="line">uname(&#123;sysname=&quot;Linux&quot;, nodename=&quot;izj6c3cqwumhn7qc8it7wiz&quot;, ...&#125;) = 0</div><div class="line">socket(AF_LOCAL, SOCK_STREAM|SOCK_CLOEXEC|SOCK_NONBLOCK, 0) = 3</div><div class="line">connect(3, &#123;sa_family=AF_LOCAL, sun_path=&quot;/var/run/nscd/socket&quot;&#125;, 110) = -1 ECONNREFUSED (Connection refused)</div><div class="line">close(3)                                = 0</div><div class="line">socket(AF_LOCAL, SOCK_STREAM|SOCK_CLOEXEC|SOCK_NONBLOCK, 0) = 3</div><div class="line">connect(3, &#123;sa_family=AF_LOCAL, sun_path=&quot;/var/run/nscd/socket&quot;&#125;, 110) = -1 ECONNREFUSED (Connection refused)</div><div class="line">close(3)                                = 0</div><div class="line">open(&quot;/etc/nsswitch.conf&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=1747, ...&#125;) = 0</div><div class="line">read(3, &quot;#\n# /etc/nsswitch.conf\n#\n# An ex&quot;..., 4096) = 1747</div><div class="line">read(3, &quot;&quot;, 4096)                       = 0</div><div class="line">close(3)                                = 0</div><div class="line">open(&quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=50151, ...&#125;) = 0</div><div class="line">close(3)                                = 0</div><div class="line">open(&quot;/lib64/libnss_dns.so.2&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">read(3, &quot;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\220\20\0\0\0\0\0\0&quot;..., 832) = 832</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=27776, ...&#125;) = 0</div><div class="line">close(3)                                = 0</div><div class="line">open(&quot;/lib64/libresolv.so.2&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">read(3, &quot;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\3209\0\0\0\0\0\0&quot;..., 832) = 832</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=111080, ...&#125;) = 0</div><div class="line">close(3)                                = 0</div><div class="line">open(&quot;/etc/host.conf&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=9, ...&#125;) = 0</div><div class="line">read(3, &quot;multi on\n&quot;, 4096)             = 9</div><div class="line">read(3, &quot;&quot;, 4096)                       = 0</div><div class="line">close(3)                                = 0</div><div class="line">socket(AF_INET, SOCK_DGRAM|SOCK_NONBLOCK, IPPROTO_IP) = 3</div><div class="line">connect(3, &#123;sa_family=AF_INET, sin_port=htons(53), sin_addr=inet_addr(&quot;100.100.2.136&quot;)&#125;, 16) = 0</div><div class="line">poll([&#123;fd=3, events=POLLOUT&#125;], 1, 0)    = 1 ([&#123;fd=3, revents=POLLOUT&#125;])</div><div class="line">sendto(3, &quot;\3146\1\0\0\1\0\0\0\0\0\0\4intl\6alipay\3com\0\0\1\0&quot;..., 33, MSG_NOSIGNAL, NULL, 0) = 33</div><div class="line">poll([&#123;fd=3, events=POLLIN&#125;], 1, 2000)  = 1 ([&#123;fd=3, revents=POLLIN&#125;])</div><div class="line">ioctl(3, FIONREAD, [263])               = 0</div><div class="line">recvfrom(3, &quot;\3146\201\200\0\1\0\3\0\4\0\6\4intl\6alipay\3com\0\0\1\0&quot;..., 1024, 0, &#123;sa_family=AF_INET, sin_port=htons(53), sin_addr=inet_addr(&quot;100.100.2.136&quot;)&#125;, [16]) = 263</div><div class="line">close(3)                                = 0</div><div class="line">fstat(1, &#123;st_mode=S_IFIFO|0600, st_size=0, ...&#125;) = 0</div><div class="line">write(1, &quot;Hostname: intl.alipay.com, was r&quot;..., 60Hostname: intl.alipay.com, was resolved to: 205.204.107.201</div><div class="line">) = 60</div><div class="line">exit_group(0)                           = ?</div><div class="line">+++ exited with 0 +++</div></pre></td></tr></table></figure>
<p>这里可以看到gethostbyname（也就是ping）的具体执行流程，具体来说分为：</p>
<ol>
<li>读/etc/resolv.conf文件，将dnsserver读入到内存中；</li>
<li>连接本地/var/run/nscd/socket（即有nscd在跑的时候就会有nscd的socket，AF_LOCAL说明连接是本地socket），连接通的话直接从nscd缓存请求，如果两次不通则进入3；</li>
<li>读/etc/nsswitch.conf文件，寻找其中的hosts:      files dns myhostname配置，其中files表示只从hosts文件取数据，dns表示执行DNS请求拿数据，这里表示优先从hosts拿，拿不到就执行DNS请求</li>
<li>读/etc/host.conf文件，其中</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">order hosts,bind   # 表示优先从hosts取信息，然后从bind取信息</div><div class="line">#order bind,hosts  </div><div class="line">multi on           # multi  on指定是否/etc/hosts文件中指定的主机可以有多个地址，拥有多个IP地址的主机一般称为多穴主机。</div></pre></td></tr></table></figure>
<ol>
<li>最后如果hosts中无信息或未配置可以从hosts中取数据，那就发起DNS请求获取结果。<br>其中需要关注：</li>
<li>条件必须要顺序满足才能生效：即如果要在步骤4中执行host文件查找，步骤3一定要支持host。但是步骤3执行host，不需要步骤4支持host</li>
</ol>
<ul>
<li>/etc/host.conf中配置order bind,hosts &amp;&amp; /etc/hosts中绑定198.11.148.201 intl.alipay.com</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line">[root@izj6c3cqwumhn7qc8it7wiz c]# strace ./gethostbyname &quot;intl.alipay.com&quot; 2&gt;&amp;1 | grep -vE &quot;mmap|munmap|mprotect&quot;</div><div class="line">execve(&quot;./gethostbyname&quot;, [&quot;./gethostbyname&quot;, &quot;intl.alipay.com&quot;], [/* 26 vars */]) = 0</div><div class="line">brk(NULL)                               = 0x82a000</div><div class="line">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</div><div class="line">open(&quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=50151, ...&#125;) = 0</div><div class="line">close(3)                                = 0</div><div class="line">open(&quot;/lib64/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">read(3, &quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\20\35\2\0\0\0\0\0&quot;..., 832) = 832</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=2127336, ...&#125;) = 0</div><div class="line">close(3)                                = 0</div><div class="line">arch_prctl(ARCH_SET_FS, 0x7f2905d51740) = 0</div><div class="line">brk(NULL)                               = 0x82a000</div><div class="line">brk(0x84b000)                           = 0x84b000</div><div class="line">brk(NULL)                               = 0x84b000</div><div class="line">getpid()                                = 16063</div><div class="line">open(&quot;/etc/resolv.conf&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=108, ...&#125;) = 0</div><div class="line">read(3, &quot;nameserver 100.100.2.138\nnameser&quot;..., 4096) = 108</div><div class="line">read(3, &quot;&quot;, 4096)                       = 0</div><div class="line">close(3)                                = 0</div><div class="line">uname(&#123;sysname=&quot;Linux&quot;, nodename=&quot;izj6c3cqwumhn7qc8it7wiz&quot;, ...&#125;) = 0</div><div class="line">socket(AF_LOCAL, SOCK_STREAM|SOCK_CLOEXEC|SOCK_NONBLOCK, 0) = 3</div><div class="line">connect(3, &#123;sa_family=AF_LOCAL, sun_path=&quot;/var/run/nscd/socket&quot;&#125;, 110) = -1 ECONNREFUSED (Connection refused)</div><div class="line">close(3)                                = 0</div><div class="line">socket(AF_LOCAL, SOCK_STREAM|SOCK_CLOEXEC|SOCK_NONBLOCK, 0) = 3</div><div class="line">connect(3, &#123;sa_family=AF_LOCAL, sun_path=&quot;/var/run/nscd/socket&quot;&#125;, 110) = -1 ECONNREFUSED (Connection refused)</div><div class="line">close(3)                                = 0</div><div class="line">open(&quot;/etc/nsswitch.conf&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=1747, ...&#125;) = 0</div><div class="line">read(3, &quot;#\n# /etc/nsswitch.conf\n#\n# An ex&quot;..., 4096) = 1747</div><div class="line">read(3, &quot;&quot;, 4096)                       = 0</div><div class="line">close(3)                                = 0</div><div class="line">open(&quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=50151, ...&#125;) = 0</div><div class="line">close(3)                                = 0</div><div class="line">open(&quot;/lib64/libnss_dns.so.2&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">read(3, &quot;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\220\20\0\0\0\0\0\0&quot;..., 832) = 832</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=27776, ...&#125;) = 0</div><div class="line">close(3)                                = 0</div><div class="line">open(&quot;/lib64/libresolv.so.2&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">read(3, &quot;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\3209\0\0\0\0\0\0&quot;..., 832) = 832</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=111080, ...&#125;) = 0</div><div class="line">close(3)                                = 0</div><div class="line">open(&quot;/etc/host.conf&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=26, ...&#125;) = 0</div><div class="line">read(3, &quot;order hosts,bind\nmulti on\n&quot;, 4096) = 26</div><div class="line">read(3, &quot;&quot;, 4096)                       = 0</div><div class="line">close(3)                                = 0</div><div class="line">socket(AF_INET, SOCK_DGRAM|SOCK_NONBLOCK, IPPROTO_IP) = 3</div><div class="line">connect(3, &#123;sa_family=AF_INET, sin_port=htons(53), sin_addr=inet_addr(&quot;100.100.2.136&quot;)&#125;, 16) = 0</div><div class="line">poll([&#123;fd=3, events=POLLOUT&#125;], 1, 0)    = 1 ([&#123;fd=3, revents=POLLOUT&#125;])</div><div class="line">sendto(3, &quot;v\255\1\0\0\1\0\0\0\0\0\0\4intl\6alipay\3com\0\0\1\0&quot;..., 33, MSG_NOSIGNAL, NULL, 0) = 33</div><div class="line">poll([&#123;fd=3, events=POLLIN&#125;], 1, 2000)  = 1 ([&#123;fd=3, revents=POLLIN&#125;])</div><div class="line">ioctl(3, FIONREAD, [263])               = 0</div><div class="line">recvfrom(3, &quot;v\255\201\200\0\1\0\3\0\4\0\6\4intl\6alipay\3com\0\0\1\0&quot;..., 1024, 0, &#123;sa_family=AF_INET, sin_port=htons(53), sin_addr=inet_addr(&quot;100.100.2.136&quot;)&#125;, [16]) = 263</div><div class="line">close(3)                                = 0</div><div class="line">fstat(1, &#123;st_mode=S_IFIFO|0600, st_size=0, ...&#125;) = 0</div><div class="line">write(1, &quot;Hostname: intl.alipay.com, was r&quot;..., 59Hostname: intl.alipay.com, was resolved to: 198.11.148.201</div><div class="line">) = 59</div><div class="line">exit_group(0)                           = ?</div><div class="line">+++ exited with 0 +++</div><div class="line">[root@izj6c3cqwumhn7qc8it7wiz c]# ping intl.alipay.com</div><div class="line">PING ihome.alipaydns.com (205.204.107.201) 56(84) bytes of data.</div><div class="line">64 bytes from 205.204.107.201: icmp_seq=1 ttl=44 time=161 ms</div><div class="line">64 bytes from 205.204.107.201: icmp_seq=2 ttl=44 time=161 ms</div><div class="line">^C</div><div class="line">--- ihome.alipaydns.com ping statistics ---</div><div class="line">2 packets transmitted, 2 received, 0% packet loss, time 3089ms</div><div class="line">rtt min/avg/max/mdev = 161.470/161.489/161.508/0.019 ms</div><div class="line">[root@izj6c3cqwumhn7qc8it7wiz c]# vi /etc/host.conf </div><div class="line">[root@izj6c3cqwumhn7qc8it7wiz c]# ping intl.alipay.com</div><div class="line">PING ihome.alipaydns.com (198.11.148.201) 56(84) bytes of data.</div><div class="line">64 bytes from 198.11.148.201 (198.11.148.201): icmp_seq=1 ttl=42 time=163 ms</div><div class="line">64 bytes from 198.11.148.201 (198.11.148.201): icmp_seq=2 ttl=42 time=163 ms</div><div class="line">^C</div><div class="line">--- ihome.alipaydns.com ping statistics ---</div><div class="line">2 packets transmitted, 2 received, 0% packet loss, time 1001ms</div><div class="line">rtt min/avg/max/mdev = 163.456/163.460/163.464/0.004 ms</div></pre></td></tr></table></figure>
<ul>
<li>/etc/nsswitch.conf中配置hosts:      files &amp;&amp; /etc/hosts不绑定host时</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">[root@izj6c3cqwumhn7qc8it7wiz c]# cat /etc/nsswitch.conf | grep hosts</div><div class="line">#hosts:     db files nisplus nis dns</div><div class="line">#hosts:      files dns myhostname</div><div class="line">hosts:      files</div><div class="line">[root@izj6c3cqwumhn7qc8it7wiz c]# strace ./gethostbyname &quot;intl.alipay.com&quot; 2&gt;&amp;1 | grep -vE &quot;mmap|munmap|mprotect|brk&quot;</div><div class="line">execve(&quot;./gethostbyname&quot;, [&quot;./gethostbyname&quot;, &quot;intl.alipay.com&quot;], [/* 26 vars */]) = 0</div><div class="line">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</div><div class="line">open(&quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=50151, ...&#125;) = 0</div><div class="line">close(3)                                = 0</div><div class="line">open(&quot;/lib64/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">read(3, &quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\20\35\2\0\0\0\0\0&quot;..., 832) = 832</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=2127336, ...&#125;) = 0</div><div class="line">close(3)                                = 0</div><div class="line">arch_prctl(ARCH_SET_FS, 0x7f07bdf5c740) = 0</div><div class="line">getpid()                                = 16099</div><div class="line">open(&quot;/etc/resolv.conf&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=108, ...&#125;) = 0</div><div class="line">read(3, &quot;nameserver 100.100.2.138\nnameser&quot;..., 4096) = 108</div><div class="line">read(3, &quot;&quot;, 4096)                       = 0</div><div class="line">close(3)                                = 0</div><div class="line">uname(&#123;sysname=&quot;Linux&quot;, nodename=&quot;izj6c3cqwumhn7qc8it7wiz&quot;, ...&#125;) = 0</div><div class="line">socket(AF_LOCAL, SOCK_STREAM|SOCK_CLOEXEC|SOCK_NONBLOCK, 0) = 3</div><div class="line">connect(3, &#123;sa_family=AF_LOCAL, sun_path=&quot;/var/run/nscd/socket&quot;&#125;, 110) = -1 ECONNREFUSED (Connection refused)</div><div class="line">close(3)                                = 0</div><div class="line">socket(AF_LOCAL, SOCK_STREAM|SOCK_CLOEXEC|SOCK_NONBLOCK, 0) = 3</div><div class="line">connect(3, &#123;sa_family=AF_LOCAL, sun_path=&quot;/var/run/nscd/socket&quot;&#125;, 110) = -1 ECONNREFUSED (Connection refused)</div><div class="line">close(3)                                = 0</div><div class="line">open(&quot;/etc/nsswitch.conf&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=1765, ...&#125;) = 0</div><div class="line">read(3, &quot;#\n# /etc/nsswitch.conf\n#\n# An ex&quot;..., 4096) = 1765</div><div class="line">read(3, &quot;&quot;, 4096)                       = 0</div><div class="line">close(3)                                = 0</div><div class="line">open(&quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=50151, ...&#125;) = 0</div><div class="line">close(3)                                = 0</div><div class="line">open(&quot;/lib64/libnss_files.so.2&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">read(3, &quot;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\320!\0\0\0\0\0\0&quot;..., 832) = 832</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=62184, ...&#125;) = 0</div><div class="line">close(3)                                = 0</div><div class="line">open(&quot;/etc/host.conf&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=44, ...&#125;) = 0</div><div class="line">read(3, &quot;#order hosts,bind\norder bind,hos&quot;..., 4096) = 44</div><div class="line">read(3, &quot;&quot;, 4096)                       = 0</div><div class="line">close(3)                                = 0</div><div class="line">open(&quot;/etc/hosts&quot;, O_RDONLY|O_CLOEXEC)  = 3</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=224, ...&#125;) = 0</div><div class="line">read(3, &quot;127.0.0.1   localhost localhost.&quot;..., 4096) = 224</div><div class="line">read(3, &quot;&quot;, 4096)                       = 0</div><div class="line">close(3)                                = 0</div><div class="line">fstat(1, &#123;st_mode=S_IFIFO|0600, st_size=0, ...&#125;) = 0</div><div class="line">write(1, &quot;intl.alipay.com was not resolved&quot;..., 33intl.alipay.com was not resolved</div><div class="line">) = 33</div><div class="line">exit_group(1)                           = ?</div><div class="line">+++ exited with 1 +++</div></pre></td></tr></table></figure>
<ul>
<li>nscd开启，相关的配置如下<br>配置:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">[root@izj6c3cqwumhn7qc8it7wiz ~]# nscd -g</div><div class="line">nscd configuration:</div><div class="line"></div><div class="line">              5  server debug level</div><div class="line">         3m 13s  server runtime</div><div class="line">              4  current number of threads</div><div class="line">             32  maximum number of threads</div><div class="line">              0  number of times clients had to wait</div><div class="line">             no  paranoia mode enabled</div><div class="line">           3600  restart internal</div><div class="line">              3  reload count</div><div class="line"></div><div class="line">hosts cache:</div><div class="line"></div><div class="line">            yes  cache is enabled</div><div class="line">            yes  cache is persistent</div><div class="line">            yes  cache is shared</div><div class="line">            211  suggested size</div><div class="line">         216064  total data pool size</div><div class="line">            232  used data pool size</div><div class="line">             10  seconds time to live for positive entries</div><div class="line">              5  seconds time to live for negative entries</div><div class="line">              0  cache hits on positive entries</div><div class="line">              0  cache hits on negative entries</div><div class="line">             36  cache misses on positive entries</div><div class="line">             25  cache misses on negative entries</div><div class="line">              0% cache hit rate</div><div class="line">              1  current number of cached values</div><div class="line">              6  maximum number of cached values</div><div class="line">              1  maximum chain length searched</div><div class="line">              0  number of delays on rdlock</div><div class="line">              0  number of delays on wrlock</div><div class="line">              0  memory allocations failed</div><div class="line">            yes  check /etc/hosts for changes</div></pre></td></tr></table></figure>
<p>其中hosts cache代表是host文件的缓存配置，具体每个参数的含义可以参考这里：<a href="https://linux.die.net/man/5/nscd.conf" target="_blank" rel="external">https://linux.die.net/man/5/nscd.conf</a>  这里代表的意思是host中配置的，每15s（10+5，不知道为啥要两个值分开这样设计？） reload一次，reload 3次仍然无新连接的话就从缓存中删除。但是查文档没有看到没在host文件中的域名的缓存策略。<br>下面是相关的实验：</p>
<ul>
<li>/etc/hosts中绑定205.204.107.201 intl.alipay.com <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">[root@izj6c3cqwumhn7qc8it7wiz c]# strace ./gethostbyname &quot;intl.alipay.com&quot; 2&gt;&amp;1 | grep -vE &quot;mmap|munmap|mprotect|brk&quot;</div><div class="line">execve(&quot;./gethostbyname&quot;, [&quot;./gethostbyname&quot;, &quot;intl.alipay.com&quot;], [/* 26 vars */]) = 0</div><div class="line">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</div><div class="line">open(&quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=50151, ...&#125;) = 0</div><div class="line">close(3)                                = 0</div><div class="line">open(&quot;/lib64/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">read(3, &quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\20\35\2\0\0\0\0\0&quot;..., 832) = 832</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=2127336, ...&#125;) = 0</div><div class="line">close(3)                                = 0</div><div class="line">arch_prctl(ARCH_SET_FS, 0x7f3a4277d740) = 0</div><div class="line">getpid()                                = 16555</div><div class="line">open(&quot;/etc/resolv.conf&quot;, O_RDONLY|O_CLOEXEC) = 3</div><div class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=108, ...&#125;) = 0</div><div class="line">read(3, &quot;nameserver 100.100.2.138\nnameser&quot;..., 4096) = 108</div><div class="line">read(3, &quot;&quot;, 4096)                       = 0</div><div class="line">close(3)                                = 0</div><div class="line">uname(&#123;sysname=&quot;Linux&quot;, nodename=&quot;izj6c3cqwumhn7qc8it7wiz&quot;, ...&#125;) = 0</div><div class="line">socket(AF_LOCAL, SOCK_STREAM|SOCK_CLOEXEC|SOCK_NONBLOCK, 0) = 3</div><div class="line">connect(3, &#123;sa_family=AF_LOCAL, sun_path=&quot;/var/run/nscd/socket&quot;&#125;, 110) = 0</div><div class="line">sendto(3, &quot;\2\0\0\0\r\0\0\0\6\0\0\0hosts\0&quot;, 18, MSG_NOSIGNAL, NULL, 0) = 18</div><div class="line">poll([&#123;fd=3, events=POLLIN|POLLERR|POLLHUP&#125;], 1, 5000) = 1 ([&#123;fd=3, revents=POLLIN|POLLHUP&#125;])</div><div class="line">recvmsg(3, &#123;msg_name(0)=NULL, msg_iov(2)=[&#123;&quot;hosts\0&quot;, 6&#125;, &#123;&quot;\310O\3\0\0\0\0\0&quot;, 8&#125;], msg_controllen=20, [&#123;cmsg_len=20, cmsg_level=SOL_SOCKET, cmsg_type=SCM_RIGHTS, [4]&#125;], msg_flags=MSG_CMSG_CLOEXEC&#125;, MSG_CMSG_CLOEXEC) = 14</div><div class="line">close(4)                                = 0</div><div class="line">close(3)                                = 0</div><div class="line">socket(AF_LOCAL, SOCK_STREAM|SOCK_CLOEXEC|SOCK_NONBLOCK, 0) = 3</div><div class="line">connect(3, &#123;sa_family=AF_LOCAL, sun_path=&quot;/var/run/nscd/socket&quot;&#125;, 110) = 0</div><div class="line">sendto(3, &quot;\2\0\0\0\4\0\0\0\20\0\0\0intl.alipay.com\0&quot;, 28, MSG_NOSIGNAL, NULL, 0) = 28</div><div class="line">poll([&#123;fd=3, events=POLLIN|POLLERR|POLLHUP&#125;], 1, 5000) = 1 ([&#123;fd=3, revents=POLLIN|POLLHUP&#125;])</div><div class="line">read(3, &quot;\2\0\0\0\1\0\0\0\20\0\0\0\0\0\0\0\2\0\0\0\4\0\0\0\1\0\0\0\0\0\0\0&quot;, 32) = 32</div><div class="line">readv(3, [&#123;&quot;intl.alipay.com\0&quot;, 16&#125;, &#123;&quot;\315\314k\311&quot;, 4&#125;], 2) = 20</div><div class="line">close(3)                                = 0</div><div class="line">fstat(1, &#123;st_mode=S_IFIFO|0600, st_size=0, ...&#125;) = 0</div><div class="line">write(1, &quot;Hostname: intl.alipay.com, was r&quot;..., 60Hostname: intl.alipay.com, was resolved to: 205.204.107.201</div><div class="line">) = 60</div><div class="line">exit_group(0)                           = ?</div><div class="line">+++ exited with 0 +++</div></pre></td></tr></table></figure>
</li>
</ul>
<p>确实是走的nscd的缓存去请求dns的（仍然是连接nscd的socket，只是这是一个本地请求，从这一句中可以看出来：connect(3, {sa_family=AF_LOCAL, sun_path=”/var/run/nscd/socket”}, 110) ）<br>请求后状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">Thu 14 Dec 2017 01:26:15 AM CST - 16531: handle_request: request received (Version = 2) from PID 16555</div><div class="line">Thu 14 Dec 2017 01:26:15 AM CST - 16531:  GETFDHST</div><div class="line">Thu 14 Dec 2017 01:26:15 AM CST - 16531: provide access to FD 7, for hosts</div><div class="line">Thu 14 Dec 2017 01:26:15 AM CST - 16531: handle_request: request received (Version = 2) from PID 16555</div><div class="line">Thu 14 Dec 2017 01:26:15 AM CST - 16531:  GETHOSTBYNAME (intl.alipay.com)</div><div class="line">Thu 14 Dec 2017 01:26:15 AM CST - 16531: Haven&apos;t found &quot;intl.alipay.com&quot; in hosts cache!</div><div class="line">Thu 14 Dec 2017 01:26:15 AM CST - 16531: add new entry &quot;intl.alipay.com&quot; of type GETHOSTBYNAME for hosts to cache (first)</div><div class="line"></div><div class="line"></div><div class="line">Thu 14 Dec 2017 01:26:36 AM CST - 16531: pruning hosts cache; time 1513185996</div><div class="line">Thu 14 Dec 2017 01:26:36 AM CST - 16531: considering GETAI entry &quot;icashier.alipay.com&quot;, timeout 1513186041</div><div class="line">Thu 14 Dec 2017 01:26:36 AM CST - 16531: considering GETHOSTBYNAME entry &quot;intl.alipay.com&quot;, timeout 1513185985</div><div class="line">Thu 14 Dec 2017 01:26:36 AM CST - 16531: Reloading &quot;intl.alipay.com&quot; in hosts cache!</div><div class="line"></div><div class="line"></div><div class="line">Thu 14 Dec 2017 01:26:51 AM CST - 16531: pruning hosts cache; time 1513186011</div><div class="line">Thu 14 Dec 2017 01:26:51 AM CST - 16531: considering GETAI entry &quot;icashier.alipay.com&quot;, timeout 1513186041</div><div class="line">Thu 14 Dec 2017 01:26:51 AM CST - 16531: considering GETHOSTBYNAME entry &quot;intl.alipay.com&quot;, timeout 1513186006</div><div class="line">Thu 14 Dec 2017 01:26:51 AM CST - 16531: Reloading &quot;intl.alipay.com&quot; in hosts cache!</div><div class="line"></div><div class="line"></div><div class="line">Thu 14 Dec 2017 01:27:06 AM CST - 16531: pruning hosts cache; time 1513186026</div><div class="line">Thu 14 Dec 2017 01:27:06 AM CST - 16531: considering GETAI entry &quot;icashier.alipay.com&quot;, timeout 1513186041</div><div class="line">Thu 14 Dec 2017 01:27:06 AM CST - 16531: considering GETHOSTBYNAME entry &quot;intl.alipay.com&quot;, timeout 1513186021</div><div class="line">Thu 14 Dec 2017 01:27:06 AM CST - 16531: Reloading &quot;intl.alipay.com&quot; in hosts cache!</div><div class="line"></div><div class="line"></div><div class="line">Thu 14 Dec 2017 01:27:21 AM CST - 16531: pruning hosts cache; time 1513186041</div><div class="line">Thu 14 Dec 2017 01:27:21 AM CST - 16531: considering GETAI entry &quot;icashier.alipay.com&quot;, timeout 1513186041</div><div class="line">Thu 14 Dec 2017 01:27:21 AM CST - 16531: considering GETHOSTBYNAME entry &quot;intl.alipay.com&quot;, timeout 1513186036</div><div class="line">Thu 14 Dec 2017 01:27:21 AM CST - 16531: remove GETHOSTBYNAME entry &quot;intl.alipay.com&quot;</div></pre></td></tr></table></figure>
<p>第一段是因为手动清理过缓存的原因，实际上应用启动时会首次加载，这里由于清理过缓存，需要请求触发加载。<br>第一段到第二段中间耗时是21s，这个值是怎么来的，官方文档中没有说明，暂时也先不看了，有空看下代码实现。二三四五中间是耗时15s，是符合预期的，第五次的时候intl域名的缓存就被清理掉了，要想加载就只能请求触发。<br>而不在hosts中的cache，就比较诡异了，看一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">Thu 14 Dec 2017 01:45:34 AM CST - 16531: handle_request: request received (Version = 2) from PID 16576</div><div class="line">Thu 14 Dec 2017 01:45:34 AM CST - 16531:  GETFDHST</div><div class="line">Thu 14 Dec 2017 01:45:34 AM CST - 16531: provide access to FD 7, for hosts</div><div class="line">Thu 14 Dec 2017 01:45:34 AM CST - 16531: handle_request: request received (Version = 2) from PID 16576</div><div class="line">Thu 14 Dec 2017 01:45:34 AM CST - 16531:  GETAI (icashier.alipay.com)</div><div class="line">Thu 14 Dec 2017 01:45:34 AM CST - 16531: Haven&apos;t found &quot;icashier.alipay.com&quot; in hosts cache!</div><div class="line">Thu 14 Dec 2017 01:45:34 AM CST - 16531: add new entry &quot;icashier.alipay.com&quot; of type GETAI for hosts to cache (first)</div><div class="line">Thu 14 Dec 2017 01:45:34 AM CST - 16531: handle_request: request received (Version = 2) from PID 16576</div><div class="line">Thu 14 Dec 2017 01:45:34 AM CST - 16531:  GETHOSTBYADDR (205.204.107.155)</div><div class="line">Thu 14 Dec 2017 01:45:34 AM CST - 16531: Haven&apos;t found &quot;205.204.107.155&quot; in hosts cache!</div><div class="line">Thu 14 Dec 2017 01:45:38 AM CST - 16531: add new entry &quot;205.204.107.155&quot; of type GETHOSTBYADDR for hosts to cache (first)</div><div class="line">Thu 14 Dec 2017 01:45:43 AM CST - 16531: pruning hosts cache; time 1513187143</div><div class="line">Thu 14 Dec 2017 01:45:43 AM CST - 16531: considering GETHOSTBYADDR entry &quot;205.204.107.155&quot;, timeout 1513187143</div><div class="line">Thu 14 Dec 2017 01:45:43 AM CST - 16531: considering GETAI entry &quot;icashier.alipay.com&quot;, timeout 1513187194</div><div class="line">Thu 14 Dec 2017 01:45:58 AM CST - 16531: pruning hosts cache; time 1513187158</div><div class="line">Thu 14 Dec 2017 01:45:58 AM CST - 16531: considering GETHOSTBYADDR entry &quot;205.204.107.155&quot;, timeout 1513187143</div><div class="line">Thu 14 Dec 2017 01:45:58 AM CST - 16531: considering GETAI entry &quot;icashier.alipay.com&quot;, timeout 1513187194</div><div class="line">Thu 14 Dec 2017 01:45:58 AM CST - 16531: remove GETHOSTBYADDR entry &quot;205.204.107.155&quot;</div><div class="line">Thu 14 Dec 2017 01:46:34 AM CST - 16531: pruning hosts cache; time 1513187194</div><div class="line">Thu 14 Dec 2017 01:46:34 AM CST - 16531: considering GETAI entry &quot;icashier.alipay.com&quot;, timeout 1513187194</div><div class="line">Thu 14 Dec 2017 01:46:49 AM CST - 16531: pruning hosts cache; time 1513187209</div><div class="line">Thu 14 Dec 2017 01:46:49 AM CST - 16531: considering GETAI entry &quot;icashier.alipay.com&quot;, timeout 1513187194</div><div class="line">Thu 14 Dec 2017 01:46:49 AM CST - 16531: Reloading &quot;icashier.alipay.com&quot; in hosts cache!</div><div class="line">Thu 14 Dec 2017 01:47:49 AM CST - 16531: pruning hosts cache; time 1513187269</div><div class="line">Thu 14 Dec 2017 01:47:49 AM CST - 16531: considering GETAI entry &quot;icashier.alipay.com&quot;, timeout 1513187269</div><div class="line">Thu 14 Dec 2017 01:48:04 AM CST - 16531: pruning hosts cache; time 1513187284</div><div class="line">Thu 14 Dec 2017 01:48:04 AM CST - 16531: considering GETAI entry &quot;icashier.alipay.com&quot;, timeout 1513187269</div><div class="line">Thu 14 Dec 2017 01:48:04 AM CST - 16531: Reloading &quot;icashier.alipay.com&quot; in hosts cache!</div><div class="line">Thu 14 Dec 2017 01:48:04 AM CST - 16531: add new entry &quot;icashier.alipay.com&quot; of type GETAI for hosts to cache (first)</div><div class="line">Thu 14 Dec 2017 01:48:04 AM CST - 16531: remove GETAI entry &quot;icashier.alipay.com&quot;</div><div class="line">Thu 14 Dec 2017 01:48:04 AM CST - 16531: freed 232 bytes in hosts cache</div></pre></td></tr></table></figure>
<p>实在没找出啥规律，后面再找找文档研究下吧。唯一确定的是在访问后确实缓存住了，重新访问的时候是直接从缓存取的，商户的请求每分钟都有十几笔，所以缓存也不会过期。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/12/02/Centos:core安装后联网和安装ifconfig/" rel="next" title="Centos:core安装后联网和安装ifconfig">
                <i class="fa fa-chevron-left"></i> Centos:core安装后联网和安装ifconfig
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="jamal-jiang" />
          <p class="site-author-name" itemprop="name">jamal-jiang</p>
          <p class="site-description motion-element" itemprop="description">落玄,程序员,技术,生活</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">40</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">34</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#gethostbyname与DNS"><span class="nav-number">1.</span> <span class="nav-text">gethostbyname与DNS</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#实验过程"><span class="nav-number">1.0.0.1.</span> <span class="nav-text">实验过程</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jamal-jiang</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  
      <!-- UY BEGIN -->
      <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid="></script>
      <!-- UY END -->
  




  
  

  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


</body>
</html>
